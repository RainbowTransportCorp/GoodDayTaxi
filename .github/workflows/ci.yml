name: Smart-CI

on:
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      services: ${{ steps.detect.outputs.services }}

    steps:
      - uses: actions/checkout@v4

      # ğŸ” ë³€ê²½ëœ ë””ë ‰í† ë¦¬ íƒì§€
      - name: Detect changed modules
        id: detect
        run: |
          echo "ğŸ” Checking changed files..."

          # ë³€ê²½ëœ ê²½ë¡œ ì¶”ì¶œ
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} HEAD)
          echo "Changed files:"
          echo "$CHANGED"

          # í”Œë˜ê·¸ ì´ˆê¸°í™”
          NEED_FULL_BUILD=false
          SERVICES=""

          for FILE in $CHANGED; do
            if [[ "$FILE" == common-core/* ]] || [[ "$FILE" == common-jpa/* ]]; then
              NEED_FULL_BUILD=true
            fi

            if [[ "$FILE" == account-service/* ]]; then
              SERVICES="$SERVICES account-service"
            fi
            if [[ "$FILE" == dispatch-service/* ]]; then
              SERVICES="$SERVICES dispatch-service"
            fi
            if [[ "$FILE" == trip-service/* ]]; then
              SERVICES="$SERVICES trip-service"
            fi
            if [[ "$FILE" == payment-service/* ]]; then
              SERVICES="$SERVICES payment-service"
            fi
            if [[ "$FILE" == support-service/* ]]; then
              SERVICES="$SERVICES support-service"
            fi
            if [[ "$FILE" == gateway/* ]]; then
              SERVICES="$SERVICES gateway"
            fi
          done

          # ê³µí†µ ëª¨ë“ˆ ë³€ê²½ â†’ ì „ì²´ ì„œë¹„ìŠ¤ ë¹Œë“œ
          if [ "$NEED_FULL_BUILD" = true ]; then
            echo "changed=ALL" >> $GITHUB_OUTPUT
            echo "services=ALL" >> $GITHUB_OUTPUT
          else
            echo "changed=SOME" >> $GITHUB_OUTPUT
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
          fi

  build:
    needs: detect-changes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Print detected changes
        run: |
          echo "Changed type: ${{ needs.detect-changes.outputs.changed }}"
          echo "Services: ${{ needs.detect-changes.outputs.services }}"

      # -------------------------------
      # ğŸŸ¢ ê³µí†µ ëª¨ë“ˆ ë³€ê²½ â†’ ì „ì²´ ë¹Œë“œ
      # -------------------------------
      - name: Build entire repository
        if: needs.detect-changes.outputs.changed == 'ALL'
        run: |
          echo "ğŸš€ Full build triggered due to common module changes."
          ./gradlew clean build --no-daemon

      # -------------------------------
      # ğŸŸ¡ ê°œë³„ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ
      # -------------------------------
      - name: Build only changed services
        if: needs.detect-changes.outputs.changed != 'ALL'
        run: |
          for SERVICE in ${{ needs.detect-changes.outputs.services }}; do
            echo "ğŸ”§ Building $SERVICE ... "
            (cd $SERVICE && ../gradlew clean build --no-daemon)
          done

      - name: Skip build
        if: needs.detect-changes.outputs.services == ''
        run: echo "â­ No services modified. Build skipped."
