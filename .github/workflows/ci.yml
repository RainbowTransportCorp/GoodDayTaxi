name: Smart Service Build

# =====================================================================
# ğŸ“Œ Trigger ì¡°ê±´
#   - PR ìƒì„±/ìˆ˜ì • ì‹œ (main ë˜ëŠ” dev)
#   - main/dev ë¸Œëœì¹˜ì— push ì‹œ
# =====================================================================
on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]


# =====================================================================
# ğŸ” ë³€ê²½ëœ ì„œë¹„ìŠ¤ ìë™ ê°ì§€ Job
# =====================================================================
jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------------
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # --------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --------------------------------------------------------------
      # 2) ë¹„êµ ê¸°ì¤€ Branch ê²°ì •
      #    - PR   â†’ base_ref
      #    - push â†’ í˜„ì¬ ref_name
      # --------------------------------------------------------------
      - name: Determine Base Branch
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "base_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # --------------------------------------------------------------
      # 3) ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶”ì¶œ
      #    - base branch fetch
      #    - merge-base ì—†ìœ¼ë©´ ì „ì²´ ë³€ê²½(ALL)
      # --------------------------------------------------------------
      - name: Get Changed Files
        id: changes
        run: |
          BASE=${{ steps.base.outputs.base_branch }}

          echo "ğŸ“Œ Base branch: $BASE"

          git fetch origin $BASE || true

          if git merge-base origin/$BASE HEAD >/dev/null 2>&1; then
            echo "ğŸ” merge-base found â†’ ì •ìƒ diff"
            CHANGED=$(git diff --name-only origin/$BASE...HEAD)
          else
            echo "âš  merge-base ì—†ìŒ â†’ ì „ì²´ ë³€ê²½ ì²˜ë¦¬ (ALL)"
            CHANGED="ALL"
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --------------------------------------------------------------
      # 4) ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ëœ ì„œë¹„ìŠ¤ íƒì§€
      # --------------------------------------------------------------
      - name: Detect Changed Services
        id: detect
        run: |
          FILES="${{ steps.changes.outputs.changed_files }}"

          if [ "$FILES" = "ALL" ]; then
            echo "services=ALL" >> $GITHUB_OUTPUT
            exit 0
          fi

          SERVICES=""

          for FILE in $FILES; do
            case $FILE in
              account-service/*) SERVICES="$SERVICES account-service" ;;
              dispatch-service/*) SERVICES="$SERVICES dispatch-service" ;;
              trip-service/*) SERVICES="$SERVICES trip-service" ;;
              payment-service/*) SERVICES="$SERVICES payment-service" ;;
              support-service/*) SERVICES="$SERVICES support-service" ;;
              gateway/*) SERVICES="$SERVICES gateway" ;;
              server/*) SERVICES="$SERVICES server" ;;
            esac
          done

          # ì¤‘ë³µ ì œê±°
          SERVICES=$(echo "$SERVICES" | xargs -n1 | sort -u | xargs)

          # ì•„ë¬´ ì„œë¹„ìŠ¤ë„ ë³€ê²½ë˜ì§€ ì•Šì•˜ë‹¤ë©´ NONE
          if [ -z "$SERVICES" ]; then
            SERVICES="NONE"
          fi

          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "ğŸ” Changed services: $SERVICES"

    outputs:
      services: ${{ steps.detect.outputs.services }}


  # =====================================================================
  # ğŸ”§ ì„œë¹„ìŠ¤ ë¹Œë“œ Job
  # =====================================================================
  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --------------------------------------------------------------
      # ğŸ”¥ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ
      # --------------------------------------------------------------
      - name: Build Changed Services
        if: needs.detect-changes.outputs.services != 'ALL' && needs.detect-changes.outputs.services != 'NONE'
        run: |
          for SERVICE in ${{ needs.detect-changes.outputs.services }}; do
            echo "ğŸ”§ Building $SERVICE ..."

            # gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x $SERVICE/gradlew

            # ì„œë¹„ìŠ¤ ë‚´ë¶€ gradlew ì‹¤í–‰
            (cd $SERVICE && ./gradlew clean build --no-daemon)
          done

      # --------------------------------------------------------------
      # ğŸ”¥ ì „ì²´ ë³€ê²½ì¸ ê²½ìš° â†’ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
      # --------------------------------------------------------------
      - name: Build ALL Services
        if: needs.detect-changes.outputs.services == 'ALL'
        run: |
          for SERVICE in account-service dispatch-service trip-service payment-service support-service gateway server; do
            echo "ğŸ”¨ Building $SERVICE ..."

            chmod +x $SERVICE/gradlew
            (cd $SERVICE && ./gradlew clean build --no-daemon)
          done

      # --------------------------------------------------------------
      # ğŸ”¥ ë³€ê²½ ì—†ìœ¼ë©´ ìŠ¤í‚µ
      # --------------------------------------------------------------
      - name: No Services Changed
        if: needs.detect-changes.outputs.services == 'NONE'
        run: echo "ğŸŸ¡ No backend changes detected â€” Build skipped."
