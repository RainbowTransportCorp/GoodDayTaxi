name: Smart Service Build

# =====================================================================
# ğŸ“Œ Trigger ì¡°ê±´
#   - PR ìƒì„±/ìˆ˜ì •: main, dev ëŒ€ìƒì¼ ë•Œ ì‹¤í–‰
#   - main, dev ë¸Œëœì¹˜ì— push ë°œìƒ ì‹œ ì‹¤í–‰
# =====================================================================
on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]


# =====================================================================
# ğŸ“Œ ë³€ê²½ëœ ì„œë¹„ìŠ¤ ìë™ ê°ì§€ Job
#   - Git diff ë¡œ ë³€ê²½ëœ íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ ì–´ë–¤ ì„œë¹„ìŠ¤ê°€ ìˆ˜ì •ëëŠ”ì§€ íƒì§€
#   - merge-baseê°€ ì—†ëŠ” ê²½ìš° â†’ ì „ì²´ ë³€ê²½ìœ¼ë¡œ íŒë‹¨(ALL)
# =====================================================================
jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------------
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # --------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --------------------------------------------------------------
      # 2) ë¹„êµ ê¸°ì¤€(base branch) ê²°ì •
      #    - PR: base_ref (ì˜ˆ: dev)
      #    - Push: í˜„ì¬ ref_name
      # --------------------------------------------------------------
      - name: Determine Base Branch
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "base_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # --------------------------------------------------------------
      # 3) ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶”ì¶œ
      #    - base ë¸Œëœì¹˜ fetch
      #    - merge-base í™•ì¸ ì‹¤íŒ¨ â†’ ì „ì²´ ë³€ê²½ìœ¼ë¡œ ê°„ì£¼(ALL)
      # --------------------------------------------------------------
      - name: Get Changed Files
        id: changes
        run: |
          BASE=${{ steps.base.outputs.base_branch }}
          echo "ğŸ“Œ Base branch: $BASE"

          # base ë¸Œëœì¹˜ ê°€ì ¸ì˜¤ê¸° (ì¡´ì¬í•˜ì§€ ì•Šì•„ë„ ë„˜ì–´ê°)
          git fetch origin $BASE || true

          # merge-base í™•ì¸ (íˆìŠ¤í† ë¦¬ ì—°ê²° ì—¬ë¶€)
          if git merge-base origin/$BASE HEAD >/dev/null 2>&1; then
            echo "ğŸ” merge-base found â†’ normal diff"
            CHANGED=$(git diff --name-only origin/$BASE...HEAD)
          else
            echo "âš ï¸ merge-base ì—†ìŒ â†’ ì „ì²´ ë³€ê²½(ALL) ì²˜ë¦¬"
            CHANGED="ALL"
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --------------------------------------------------------------
      # 4) ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ìœ¼ë¡œ ì–´ëŠ ì„œë¹„ìŠ¤ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ íƒì§€
      #    - ì„œë¹„ìŠ¤ë³„ í´ë” ì´ë¦„ íŒ¨í„´ ë§¤ì¹­
      #    - ë³€ê²½ ì—†ìŒ â†’ NONE
      #    - ì „ì²´ ë³€ê²½ â†’ ALL
      # --------------------------------------------------------------
      - name: Detect Changed Services
        id: detect
        run: |
          FILES="${{ steps.changes.outputs.changed_files }}"

          # ì „ì²´ ë³€ê²½ ì²˜ë¦¬
          if [ "$FILES" = "ALL" ]; then
            echo "services=ALL" >> $GITHUB_OUTPUT
            exit 0
          fi

          SERVICES=""
          for FILE in $FILES; do
            case $FILE in
              account-service/*) SERVICES="$SERVICES account-service" ;;
              dispatch-service/*) SERVICES="$SERVICES dispatch-service" ;;
              trip-service/*) SERVICES="$SERVICES trip-service" ;;
              payment-service/*) SERVICES="$SERVICES payment-service" ;;
              support-service/*) SERVICES="$SERVICES support-service" ;;
              gateway/*) SERVICES="$SERVICES gateway" ;;
              server/*) SERVICES="$SERVICES server" ;;
            esac
          done

          # ì¤‘ë³µ ì œê±°
          SERVICES=$(echo "$SERVICES" | xargs -n1 | sort -u | xargs)

          # ê°ì§€ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìœ¼ë©´ NONE
          if [ -z "$SERVICES" ]; then
            SERVICES="NONE"
          fi

          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "ğŸ” Changed services: $SERVICES"

    # detect job output â†’ build jobì—ì„œ ì‚¬ìš©
    outputs:
      services: ${{ steps.detect.outputs.services }}


  # =====================================================================
  # ğŸ“Œ ì„œë¹„ìŠ¤ ë¹Œë“œ Job
  #   - detect-changes Job ê²°ê³¼ì— ë”°ë¼ ë¹Œë“œ ë²”ìœ„ ê²°ì •
  #   - ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ
  #   - ì „ì²´ ë³€ê²½ â†’ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
  #   - ë³€ê²½ ì—†ìŒ â†’ ìŠ¤í‚µ
  # =====================================================================
  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --------------------------------------------------------------
      # ğŸ”¥ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ê°œë³„ gradlew ë¡œ ë¹Œë“œ
      # --------------------------------------------------------------
      - name: Build Changed Services
        if: needs.detect-changes.outputs.services != 'ALL' && needs.detect-changes.outputs.services != 'NONE'
        run: |
          for SERVICE in ${{ needs.detect-changes.outputs.services }}; do
            echo "ğŸ”§ Building $SERVICE ..."
            (cd $SERVICE && ../gradlew clean build --no-daemon)
          done

      # --------------------------------------------------------------
      # ğŸ”¥ ì „ì²´ ì„œë¹„ìŠ¤ ë¹Œë“œ (ALL)
      #     root gradlew ì—†ìŒ â†’ ì„œë¹„ìŠ¤ë³„ gradlew ë°˜ë³µ ë¹Œë“œ
      # --------------------------------------------------------------
      - name: Build ALL Services
        if: needs.detect-changes.outputs.services == 'ALL'
        run: |
          for SERVICE in account-service dispatch-service trip-service payment-service support-service gateway server; do
            echo "ğŸ”¨ Building $SERVICE ..."
            (cd $SERVICE && ../gradlew clean build --no-daemon)
          done

      # --------------------------------------------------------------
      # ğŸ”¥ ë³€ê²½ ì—†ëŠ” ê²½ìš°
      # --------------------------------------------------------------
      - name: No Services Changed
        if: needs.detect-changes.outputs.services == 'NONE'
        run: echo "ğŸŸ¡ No backend service changes detected â€” Build skipped."
