name: Smart Service Build

# ------------------------------------------------------------
# ğŸ“Œ CI Trigger ì¡°ê±´
#  - PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ (main ë˜ëŠ” dev ëŒ€ìƒìœ¼ë¡œ)
#  - main ë˜ëŠ” dev ë¸Œëœì¹˜ì— push ë°œìƒ ì‹œ
# ------------------------------------------------------------
on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - main
      - dev

# ------------------------------------------------------------
# ğŸ“Œ ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€ Job
#   - PR ë˜ëŠ” push ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
#   - MSA ì„œë¹„ìŠ¤ í´ë”(account/dispatch/...) ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½ ê°ì§€
#   - ê°ì§€ ì‹¤íŒ¨ ì‹œ ì „ì²´ ë¹Œë“œ(ALL) fallback
# ------------------------------------------------------------
jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # --------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v3

      # --------------------------------------------------------
      # ğŸ” ë¹„êµ ëŒ€ìƒ(base branch) ê²°ì •
      #   - PR: base_ref ì‚¬ìš©
      #   - PUSH: í˜„ì¬ ë¸Œëœì¹˜ ê¸°ì¤€
      # --------------------------------------------------------
      - name: Determine base branch
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            # pushì¼ ë•ŒëŠ” ref_name ì‚¬ìš©
            echo "base_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # --------------------------------------------------------
      # ğŸ” ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
      #   - base branchê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° ì „ì²´ ë¹Œë“œë¡œ fallback
      # --------------------------------------------------------
      - name: Get changed files
        id: changes
        run: |
          BASE=${{ steps.base.outputs.base_branch }}

          echo "ğŸ” Checking diff from origin/$BASE..."

          # ì—†ëŠ” ë¸Œëœì¹˜ ëŒ€ë¹„ (ì˜ˆ: ì²« CI)
          git fetch origin $BASE || echo "âš ï¸ Base branch not found, fallback to ALL"

          if git rev-parse origin/$BASE >/dev/null 2>&1; then
            CHANGED=$(git diff --name-only origin/$BASE...HEAD)
          else
            CHANGED="ALL"
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
      # ğŸ” ë³€ê²½ëœ ê²½ë¡œì—ì„œ MSA ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ ê°ì§€
      #   - account-service
      #   - dispatch-service
      #   - trip-service
      #   - payment-service
      #   - support-service
      #   - gateway
      #   - server
      # --------------------------------------------------------
      - name: Detect changed services
        id: detect
        run: |
          FILES="${{ steps.changes.outputs.changed_files }}"

          # ì „ì²´ ë³€ê²½ìœ¼ë¡œ íŒë‹¨ëœ ê²½ìš°
          if [ "$FILES" = "ALL" ]; then
            echo "services=ALL" >> $GITHUB_OUTPUT
            exit 0
          fi

          SERVICES=""
          for FILE in $FILES; do
            case $FILE in
              account-service/*) SERVICES="$SERVICES account-service" ;;
              dispatch-service/*) SERVICES="$SERVICES dispatch-service" ;;
              trip-service/*) SERVICES="$SERVICES trip-service" ;;
              payment-service/*) SERVICES="$SERVICES payment-service" ;;
              support-service/*) SERVICES="$SERVICES support-service" ;;
              gateway/*) SERVICES="$SERVICES gateway" ;;
              server/*) SERVICES="$SERVICES server" ;;
            esac
          done

          # ì¤‘ë³µ ì œê±°
          SERVICES=$(echo "$SERVICES" | xargs -n1 | sort -u | xargs)

          # ê°ì§€ëœ ì„œë¹„ìŠ¤ ì—†ìœ¼ë©´ NONE
          if [ -z "$SERVICES" ]; then
            SERVICES="NONE"
          fi

          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "ğŸ” Changed services: $SERVICES"

    outputs:
      services: ${{ steps.detect.outputs.services }}

  # ------------------------------------------------------------
  # ğŸ“Œ ë¹Œë“œ Job
  #   - ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ íƒ€ê²Ÿ ë¹Œë“œ
  #   - ì „ì²´ ë³€ê²½ ì‹œ ì „ì²´ ë¹Œë“œ
  #   - ë³€ê²½ ì—†ìŒ(NONE)ì€ ìŠ¤í‚µ ì²˜ë¦¬
  # ------------------------------------------------------------
  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # --------------------------------------------------------
      # gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (í•„ìˆ˜)
      # --------------------------------------------------------
      - name: Grant permission to gradlew
        run: chmod +x gradlew

      # --------------------------------------------------------
      # ğŸ”¥ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ì„ íƒ ë¹Œë“œ
      # --------------------------------------------------------
      - name: Build Changed Services
        if: needs.detect-changes.outputs.services != 'ALL' && needs.detect-changes.outputs.services != 'NONE'
        run: |
          for SERVICE in ${{ needs.detect-changes.outputs.services }}; do
            echo "ğŸ”§ Building $SERVICE..."
            (cd $SERVICE && ../gradlew clean build --no-daemon)
          done

      # --------------------------------------------------------
      # ğŸ”¥ ì „ì²´ ì„œë¹„ìŠ¤ ë¹Œë“œ (fallback or core ë³€ê²½ ì‹œ)
      # --------------------------------------------------------
      - name: Build ALL Services
        if: needs.detect-changes.outputs.services == 'ALL'
        run: ./gradlew clean build --no-daemon

      # --------------------------------------------------------
      # ğŸ”¥ ë³€ê²½ëœ ì„œë¹„ìŠ¤ ì—†ëŠ” ê²½ìš°
      # --------------------------------------------------------
      - name: No Services Changed
        if: needs.detect-changes.outputs.services == 'NONE'
        run: echo "ğŸŸ¡ No backend service changes detected â€” Build skipped."
