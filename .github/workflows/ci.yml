name: Smart Service Build

# ------------------------------------------------------------
# ğŸ“Œ CI Trigger ì¡°ê±´
#  - PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ (main ë˜ëŠ” dev ëŒ€ìƒìœ¼ë¡œ)
#  - main ë˜ëŠ” dev ë¸Œëœì¹˜ì— push ë°œìƒ ì‹œ
# ------------------------------------------------------------
on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - main
      - dev

jobs:
  # ----------------------------------------------------------
  # ğŸ” ë³€ê²½ëœ ì„œë¹„ìŠ¤ ìë™ ê°ì§€ Job
  # ----------------------------------------------------------
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # ì½”ë“œë¥¼ Checkout
      # --------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v3

      # --------------------------------------------------------
      # ë¹„êµ ëŒ€ìƒ ë¸Œëœì¹˜(Base branch) ê²°ì •
      #   - PRì´ë©´ base_ref ì‚¬ìš©
      #   - pushë©´ í˜„ì¬ ref
      # --------------------------------------------------------
      - name: Determine base branch
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "base_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # --------------------------------------------------------
      # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
      # 1) origin/BASE ë¸Œëœì¹˜ fetch
      # 2) merge-base í™•ì¸
      #   - merge-base ì—†ìŒ â†’ ì „ì²´ ë³€ê²½ìœ¼ë¡œ ê°„ì£¼ (ALL)
      # 3) diff ì„±ê³µ â†’ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
      # --------------------------------------------------------
      - name: Get changed files
        id: changes
        run: |
          BASE=${{ steps.base.outputs.base_branch }}
          echo "ğŸ” Checking diff from origin/$BASE..."

          # base ë¸Œëœì¹˜ ê°€ì ¸ì˜¤ê¸° (ì—†ì–´ë„ ë„˜ì–´ê°)
          git fetch origin $BASE || true

          # merge-base ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if git merge-base origin/$BASE HEAD >/dev/null 2>&1; then
            echo "ğŸ” merge-base found. Running git diff..."
            CHANGED=$(git diff --name-only origin/$BASE...HEAD)
          else
            echo "âš ï¸ No merge base found â€” fallback to ALL"
            CHANGED="ALL"
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
      # ğŸ” ë³€ê²½ëœ ê²½ë¡œì—ì„œ MSA ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ ê°ì§€
      #   - account-service
      #   - dispatch-service
      #   - trip-service
      #   - payment-service
      #   - support-service
      #   - gateway
      #   - server
      # --------------------------------------------------------
      - name: Detect changed services
        id: detect
        run: |
          FILES="${{ steps.changes.outputs.changed_files }}"

          # ì „ì²´ ë³€ê²½ ì‹œ ALL ë°˜í™˜
          if [ "$FILES" = "ALL" ]; then
            echo "services=ALL" >> $GITHUB_OUTPUT
            exit 0
          fi

          SERVICES=""
          for FILE in $FILES; do
            case $FILE in
              account-service/*) SERVICES="$SERVICES account-service" ;;
              dispatch-service/*) SERVICES="$SERVICES dispatch-service" ;;
              trip-service/*) SERVICES="$SERVICES trip-service" ;;
              payment-service/*) SERVICES="$SERVICES payment-service" ;;
              support-service/*) SERVICES="$SERVICES support-service" ;;
              gateway/*) SERVICES="$SERVICES gateway" ;;
              server/*) SERVICES="$SERVICES server" ;;
            esac
          done

          # ì¤‘ë³µ ì œê±°
          SERVICES=$(echo "$SERVICES" | xargs -n1 | sort -u | xargs)

          # ê°ì§€ëœ ì„œë¹„ìŠ¤ ì—†ìœ¼ë©´ NONE
          if [ -z "$SERVICES" ]; then
            SERVICES="NONE"
          fi

          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "ğŸ” Changed services: $SERVICES"

    outputs:
      services: ${{ steps.detect.outputs.services }}

  # ----------------------------------------------------------
  # ğŸ”§ ì„ íƒ ë¹Œë“œ Job
  # ----------------------------------------------------------
  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # --------------------------------------------------------
      # gradlew ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ê¶Œí•œ ë¶€ì—¬
      # --------------------------------------------------------
      - name: Grant permission to gradlew
        run: chmod +x gradlew

      # --------------------------------------------------------
      # ğŸ”¥ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ê°œë³„ ë¹Œë“œ
      # --------------------------------------------------------
      - name: Build Changed Services
        if: needs.detect-changes.outputs.services != 'ALL' && needs.detect-changes.outputs.services != 'NONE'
        run: |
          for SERVICE in ${{ needs.detect-changes.outputs.services }}; do
            echo "ğŸ”§ Building $SERVICE..."
            (cd $SERVICE && ../gradlew clean build --no-daemon)
          done

      # --------------------------------------------------------
      # ğŸ”¥ ì „ì²´ ì„œë¹„ìŠ¤ ë¹Œë“œ (ALL)
      # --------------------------------------------------------
      - name: Build ALL Services
        if: needs.detect-changes.outputs.services == 'ALL'
        run: ./gradlew clean build --no-daemon

      # --------------------------------------------------------
      # ğŸ”¥ ì„œë¹„ìŠ¤ ë³€ê²½ì´ ì—†ëŠ” ê²½ìš° (NONE)
      # --------------------------------------------------------
      - name: No Services Changed
        if: needs.detect-changes.outputs.services == 'NONE'
        run: echo "ğŸŸ¡ No backend service changes detected â€” Build skipped."
