<script>
  const token = localStorage.getItem("accessToken");
  const uuid = localStorage.getItem("userUuid");

  if (!token || !uuid) {
    alert("로그인이 필요합니다.");
    location.href = "/index.html";
  }

  const headers = {
    "Authorization": `Bearer ${token}`,
    "X-User-UUID": uuid,
    "X-User-Role": "DRIVER"
  };

  let pollingId = null;
  let previousStatus = null;

  function renderTrip(trip) {
    document.getElementById("pickup").textContent =
        trip.pickupAddress ?? "-";
    document.getElementById("destination").textContent =
        trip.destinationAddress ?? "-";

    // 공통 인디케이터용
    localStorage.setItem("tripId", trip.id);
    localStorage.setItem("tripStatus", trip.status);
  }

  async function pollTripStatus() {
    try {
      const res = await fetch("/api/v1/trips/drivers/active", { headers });

      // ✅ ACTIVE 아님 = 운행 종료 or 없음 → 콜 대기
      if (res.status === 204 || res.status === 404) {
        clearInterval(pollingId);
        location.href = "/driver/dashboard/index.html";
        return;
      }

      if (res.status === 401 || res.status === 403) {
        alert("세션이 만료되었습니다. 다시 로그인해주세요.");
        location.href = "/index.html";
        return;
      }

      if (!res.ok) {
        console.warn("운행 상태 조회 실패:", res.status);
        return;
      }

      const { data: trip } = await res.json();
      if (!trip || !trip.status) return;

      renderTrip(trip);

      // ✅ 상태 변화 감지
      if (trip.status !== previousStatus) {
        previousStatus = trip.status;

        switch (trip.status) {
          case "STARTED":
            // stay
            break;

          case "ENDED":
            clearInterval(pollingId);

            localStorage.removeItem("tripId");
            localStorage.removeItem("tripStatus");

            location.href = "ended.html";
            break;

          case "READY":
            // 이론상 active에 READY가 오면 안 되지만
            // 안전장치
            location.href = "ready.html";
            break;
        }
      }

    } catch (e) {
      console.error("운행 상태 polling 실패", e);
    }
  }

  // ✅ 운행 완료 버튼
  function completeTrip() {
    fetch("/api/v1/trips/complete", {
      method: "PATCH",
      headers
    })
    .then(res => {
      if (!res.ok) {
        return res.json().then(j => {
          throw new Error(j.message || "운행 완료 실패");
        });
      }
      // ❗ 여기서는 redirect 안 함
      // → 상태 변경은 polling이 감지
    })
    .catch(e => {
      console.error("운행 완료 실패", e);
      alert(e.message);
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    pollTripStatus();
    pollingId = setInterval(pollTripStatus, 3000);
  });
</script>
