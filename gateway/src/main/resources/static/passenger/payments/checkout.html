<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결제하기 | Good Day Taxi</title>

    <!-- TossPayments SDK -->
    <script src="https://js.tosspayments.com/v2/standard"></script>

    <!-- ✅ 정적 처리 대상이라면 이렇게 -->
    <link rel="stylesheet" href="/common/header.css">
    <script src="/common/header-static.js" defer></script>

    <style>
        body {
            margin: 0;
            background: #f7f7fb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        }

        main {
            max-width: 480px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .coupon {
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .btn-pay {
            width: 100%;
            margin-top: 20px;
            padding: 14px;
            border-radius: 999px;
            border: none;
            background: #8A5DF6;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>

<body>

<header class="header-static"></header>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const res = await fetch("/common/header-static.html");
        document.querySelector("header").innerHTML = await res.text();
    });
</script>

<main>
    <div class="card">
        <!-- 쿠폰 (MVP 단계 비활성) -->
        <div class="coupon">
            <input type="checkbox" disabled />
            <label>5,000원 쿠폰 적용 (준비 중)</label>
        </div>

        <!-- 결제 수단 -->
        <div id="payment-method"></div>

        <!-- 약관 -->
        <div id="agreement"></div>

        <!-- 결제 버튼 -->
        <button class="btn-pay" id="payment-button">결제하기</button>
    </div>
</main>

<script>
    /* ===== 공통 유틸 ===== */
    function getToken() {
        return localStorage.getItem("accessToken");
    }

    function getUserUuid() {
        return localStorage.getItem("userUuid");
    }

    function getRole() {
        return localStorage.getItem("role");
    }

    function buildHeaders(role) {
        return {
            "Authorization": `Bearer ${getToken()}`,
            "X-User-UUID": getUserUuid(),
            "X-User-Role": role,
            "Content-Type": "application/json"
        };
    }

    function guardPassenger() {
        const token = getToken();
        const role = getRole();
        if (!token || role !== "PASSENGER") {
            alert("승객 전용 페이지입니다.");
            location.href = "/index.html";
            return false;
        }
        return true;
    }

    async function loadHeader() {
        const header = document.querySelector("header");
        const res = await fetch("/common/header.html");
        header.innerHTML = await res.text();
    }

    /* ===== 결제 메인 로직 ===== */
    async function main() {
        if (!guardPassenger()) return;
        await loadHeader();

        const params = new URLSearchParams(location.search);
        const tripId = params.get("tripId");
        if (!tripId) {
            alert("운행 정보가 없습니다.");
            location.href = "/passenger/dashboard/index.html";
            return;
        }

        const res = await fetch(`/api/v1/payments/tosspay/ready?tripId=${tripId}`, {
            method: "GET",
            headers: buildHeaders("PASSENGER")
        });

        if (!res.ok) {
            alert("결제 준비 중 오류가 발생했습니다.");
            location.href = "/passenger/dashboard/index.html";
            return;
        }

        const json = await res.json();
        const { orderId, customerKey, amount } = json.data;

        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        const tossPayments = TossPayments(clientKey);
        const widgets = tossPayments.widgets({ customerKey });

        await widgets.setAmount({ currency: "KRW", value: amount });

        await Promise.all([
            widgets.renderPaymentMethods({
                selector: "#payment-method",
                variantKey: "DEFAULT"
            }),
            widgets.renderAgreement({
                selector: "#agreement",
                variantKey: "AGREEMENT"
            })
        ]);

        const button = document.getElementById("payment-button");
        button.addEventListener("click", async () => {
            await widgets.requestPayment({
                orderId,
                orderName: "운수좋은 날 운행",
                successUrl: `${location.origin}/passenger/payments/processing.html`,
                failUrl: `${location.origin}/passenger/payments/fail.html`
            });
        });
    }

    main();
</script>
</body>
</html>
