<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ê²°ì œ ì²˜ë¦¬ ì¤‘ | Good day Taxi</title>

    <!-- âœ… ê³µí†µ í—¤ë” -->
    <link rel="stylesheet" href="/common/header.css" />
    <script src="/common/header.js" defer></script>

    <style>
        body {
            margin: 0;
            background: #f7f7fb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        }

        main {
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 80px);
            padding: 20px;
        }

        .card {
            background: white;
            padding: 36px 28px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            text-align: center;
            max-width: 380px;
            width: 100%;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 12px;
        }

        .desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .info {
            font-size: 13px;
            color: #444;
            background: #fafafa;
            border-radius: 12px;
            padding: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<!-- âœ… ê³µí†µ í—¤ë” -->
<header></header>

<main>
    <div class="card">
        <h2>ğŸ’³ ê²°ì œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤</h2>
        <div class="desc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>

        <div class="info" id="orderId"></div>
        <div class="info" id="amount"></div>
    </div>
</main>

<script>
    /* ================= ì¸ì¦ ê°€ë“œ ================= */

    function guardPassenger() {
        const token = localStorage.getItem("accessToken");
        const role = localStorage.getItem("role");
        if (!token || role !== "PASSENGER") {
            alert("ìŠ¹ê° ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤.");
            location.href = "/index.html";
            return false;
        }
        return true;
    }

    async function loadHeader() {
        const header = document.querySelector("header");
        try {
            const res = await fetch("/common/header.html");
            header.innerHTML = await res.text();
        } catch (e) {
            console.error("ê³µí†µ í—¤ë” ë¡œë”© ì‹¤íŒ¨", e);
        }
    }

    /* ================= Idempotency Key ================= */

    function generateIdempotencyKey({ orderId, amount, passengerId }) {
        return [orderId, amount, passengerId].join(":");
    }

    function getOrCreateIdempotencyKey({ orderId, amount, passengerId }) {
        const STORAGE_KEY = "payment-confirm-idempotency-key";

        const stored = sessionStorage.getItem(STORAGE_KEY);
        if (stored) return stored;

        const newKey = generateIdempotencyKey({ orderId, amount, passengerId });
        sessionStorage.setItem(STORAGE_KEY, newKey);
        return newKey;
    }

    /* ================= ê²°ì œ ìŠ¹ì¸ ================= */

    async function confirmPayment() {
        if (!guardPassenger()) return;
        await loadHeader();

        const params = new URLSearchParams(location.search);
        const customerKey = params.get("customerKey");
        const paymentKey = params.get("paymentKey");
        const orderId = params.get("orderId");
        const amount = params.get("amount");

        if (!customerKey || !paymentKey || !orderId || !amount) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            location.href = "/passenger/dashboard/index.html";
            return;
        }

        const passengerId = customerKey.replace(/^customer-/, "");
        const idempotencyKey = getOrCreateIdempotencyKey({
            orderId,
            amount,
            passengerId
        });

        document.getElementById("orderId").textContent = `ì£¼ë¬¸ë²ˆí˜¸: ${orderId}`;
        document.getElementById("amount").textContent = `ê²°ì œ ê¸ˆì•¡: ${Number(amount).toLocaleString()}ì›`;

        try {
            const response = await fetch("/api/v1/payments/tosspay/confirm", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-User-UUID": passengerId,
                    "X-User-Role": "PASSENGER",
                    "Idempotency-Key": idempotencyKey
                },
                body: JSON.stringify({
                    paymentKey,
                    orderId,
                    amount
                })
            });

            const json = await response.json();

            if (!response.ok) {
                window.location.href =
                    `/passenger/payments/fail.html` +
                    `?message=${encodeURIComponent(json.message)}` +
                    `&orderId=${orderId}` +
                    `&amount=${amount}` +
                    `&customerKey=${customerKey}`;
                return;
            }

            /* âœ… ê²°ì œ ì„±ê³µ ì²˜ë¦¬ */
            sessionStorage.removeItem("payment-confirm-idempotency-key");
            localStorage.removeItem("unpaidTrip");

            window.location.href = "/passenger/payments/success.html";

        } catch (e) {
            console.error(e);
            window.location.href = "/passenger/payments/fail.html?message=ê²°ì œ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
    }

    confirmPayment();
</script>
</body>
</html>
